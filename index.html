<script>
/* ----------------------------
   SISTEMA DE CORRIDA SEM MAPS
   ---------------------------- */

const state = {
  base: 5.00,
  perKm: 2.50,
  distanceKm: 0,
  userCoords: null
};

/* --- FÓRMULA DE HAVERSINE (Km entre 2 coordenadas) --- */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // raio da terra
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
      Math.sin(dLat/2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon/2) ** 2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c; // distância em km
}

/* --- Obter coordenadas do usuário --- */
document.getElementById("useMyLocation").onclick = () => {
  if (!navigator.geolocation) {
    alert("Seu navegador não suporta geolocalização.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      state.userCoords = { latitude, longitude };

      document.getElementById("pickup").value =
        `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

      document.getElementById("summaryContent").innerHTML =
        `<strong>Origem definida via GPS</strong><br>` +
        `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
    },
    err => alert("Não foi possível obter sua localização.")
  );
};

/* --- Extrair coordenadas de um texto "lat, lng" --- */
function parseCoords(text) {
  const match = text.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
  return match ? { lat: parseFloat(match[1]), lng: parseFloat(match[2]) } : null;
}

/* --- Calcular distância --- */
document.getElementById("estimateBtn").onclick = () => {
  const pickup = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();

  const originCoords = parseCoords(pickup);
  const destCoords   = parseCoords(dropoff);

  if (!originCoords || !destCoords) {
    alert("Origem e destino precisam estar no formato coordenadas: -22.123456, -43.123456");
    return;
  }

  const km = haversine(
    originCoords.lat, originCoords.lng,
    destCoords.lat,  destCoords.lng
  );

  const price = (state.base + km * state.perKm).toFixed(2);
  state.distanceKm = km;

  document.getElementById("estimate").innerText = price;

  document.getElementById("summaryTitle").innerText = "Resumo da corrida";
  document.getElementById("summaryContent").innerHTML =
    `<strong>Origem:</strong> ${pickup}<br>` +
    `<strong>Destino:</strong> ${dropoff}<br>` +
    `<strong>Distância:</strong> ${km.toFixed(2)} km<br>` +
    `<strong>Preço estimado:</strong> R$ ${price}`;
};

/* --- Enviar via WhatsApp --- */
document.getElementById("requestBtn").onclick = () => {
  const owner = document.getElementById("ownerPhone").value.replace(/[^0-9]/g, "");

  if (owner.length < 10) {
    alert("Informe o número do motorista.");
    return;
  }

  const msg =
    `Pedido de corrida:%0A` +
    `Origem: ${document.getElementById("pickup").value}%0A` +
    `Destino: ${document.getElementById("dropoff").value}%0A` +
    `Distância: ${state.distanceKm.toFixed(2)} km%0A` +
    `Valor estimado: R$ ${document.getElementById("estimate").innerText}%0A`;

  window.open(`https://wa.me/${owner}?text=${msg}`, "_blank");
};
</script>
